#!/usr/bin/env bash
set -e

# Script unificado para desenvolvimento local
# Inicia: Docker Compose (PostgreSQL + Redis) + Backend Rails + Frontend Next.js

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Fun√ß√£o para log colorido
log_info() {
  echo -e "${BLUE}‚Ñπ ${NC} $1"
}

log_success() {
  echo -e "${GREEN}‚úì${NC} $1"
}

log_warn() {
  echo -e "${YELLOW}‚ö†${NC} $1"
}

log_error() {
  echo -e "${RED}‚úó${NC} $1"
}

# Fun√ß√£o de limpeza ao sair (Ctrl+C)
cleanup() {
  log_warn "\nEncerrando servi√ßos..."
  
  # Mata processos filhos (backend e frontend)
  jobs -p | xargs -r kill 2>/dev/null || true
  
  # Para containers Docker (opcional - descomente se quiser parar ao sair)
  # $DOCKER_COMPOSE down
  
  log_success "Servi√ßos encerrados"
  exit 0
}

trap cleanup SIGINT SIGTERM

# Banner
echo -e "${BLUE}"
cat << "EOF"
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë   üè• Sistema de Gest√£o de Cl√≠nica        ‚ïë
‚ïë      Ambiente de Desenvolvimento         ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
EOF
echo -e "${NC}"

# Verificar depend√™ncias
log_info "Verificando depend√™ncias..."

if ! command -v docker &> /dev/null; then
  log_error "Docker n√£o encontrado. Instale: https://docs.docker.com/get-docker/"
  log_warn "Se estiver no WSL 2, ative a integra√ß√£o no Docker Desktop:"
  log_warn "Settings ‚Üí Resources ‚Üí WSL Integration ‚Üí Enable integration"
  exit 1
fi

# Detectar docker compose (v2 - novo) ou docker-compose (v1 - antigo)
if docker compose version &> /dev/null 2>&1; then
  DOCKER_COMPOSE="docker compose"
elif command -v docker-compose &> /dev/null && docker-compose version &> /dev/null 2>&1; then
  DOCKER_COMPOSE="docker-compose"
else
  log_error "Docker Compose n√£o encontrado."
  log_warn "Se estiver no WSL 2, ative a integra√ß√£o no Docker Desktop:"
  log_warn "Settings ‚Üí Resources ‚Üí WSL Integration ‚Üí Enable integration with your distro"
  log_warn "Ou instale: https://docs.docker.com/compose/install/"
  exit 1
fi

log_success "Usando: $DOCKER_COMPOSE"

# Verificar se j√° existe uma instala√ß√£o de Ruby/Node (avisar se n√£o existir)
if ! command -v ruby &> /dev/null; then
  log_warn "Ruby n√£o encontrado. Backend pode n√£o iniciar."
fi

if ! command -v node &> /dev/null; then
  log_warn "Node.js n√£o encontrado. Frontend pode n√£o iniciar."
fi

# 1. Iniciar Docker Compose (PostgreSQL + Redis)
log_info "Iniciando containers Docker (PostgreSQL + Redis)..."
$DOCKER_COMPOSE up -d

# Aguardar PostgreSQL estar pronto (com timeout de 60 segundos)
log_info "Aguardando PostgreSQL estar pronto..."
POSTGRES_TIMEOUT=60
POSTGRES_ELAPSED=0
until $DOCKER_COMPOSE exec -T db pg_isready -U fono &> /dev/null; do
  sleep 2
  POSTGRES_ELAPSED=$((POSTGRES_ELAPSED + 2))
  
  if [ $POSTGRES_ELAPSED -ge $POSTGRES_TIMEOUT ]; then
    log_error "PostgreSQL n√£o ficou pronto em ${POSTGRES_TIMEOUT}s"
    log_info "Verificando logs do container:"
    $DOCKER_COMPOSE logs db | tail -20
    log_warn "\nTente:"
    log_warn "  1. $DOCKER_COMPOSE down"
    log_warn "  2. $DOCKER_COMPOSE up -d"
    log_warn "  3. $DOCKER_COMPOSE logs -f db"
    exit 1
  fi
  
  # Mostrar progresso
  if [ $((POSTGRES_ELAPSED % 10)) -eq 0 ]; then
    log_info "Ainda aguardando... (${POSTGRES_ELAPSED}s/${POSTGRES_TIMEOUT}s)"
  fi
done
log_success "PostgreSQL pronto"

# 2. Setup do Backend (se necess√°rio)
if [ ! -f "backend/.env" ]; then
  log_warn "Arquivo backend/.env n√£o encontrado. Criando..."
  cat > backend/.env << 'ENVFILE'
DATABASE_URL=postgresql://fono:fono123@localhost:5433/fono_db
REDIS_URL=redis://localhost:6380/0
DEVISE_JWT_SECRET_KEY=seu_secret_key_aqui_troque_em_producao
ENVFILE
  log_success "Arquivo backend/.env criado"
fi

# Verificar se precisa instalar gems
if [ ! -d "backend/vendor/bundle" ] && [ ! -f "backend/.bundle/config" ]; then
  log_info "Instalando gems do backend..."
  cd backend
  bundle install
  cd ..
  log_success "Gems instaladas"
fi

# Verificar se precisa criar/migrar banco
cd backend
if ! bundle exec rails db:version &> /dev/null; then
  log_info "Criando e migrando banco de dados..."
  bundle exec rails db:create db:migrate db:seed
  log_success "Banco de dados pronto"
else
  log_info "Executando migra√ß√µes pendentes..."
  bundle exec rails db:migrate
fi
cd ..

# 3. Setup do Frontend (se necess√°rio)
if [ ! -d "frontend/node_modules" ]; then
  log_info "Instalando depend√™ncias do frontend..."
  cd frontend
  npm install
  cd ..
  log_success "Depend√™ncias instaladas"
fi

# 4. Iniciar servi√ßos
log_success "\nIniciando servi√ßos de desenvolvimento...\n"

# Backend Rails (porta 3001)
log_info "Iniciando Backend Rails em http://localhost:3001"
cd backend
bundle exec rails server -p 3001 > ../logs/backend.log 2>&1 &
BACKEND_PID=$!
cd ..

# Aguardar backend estar pronto
sleep 3

# Frontend Next.js (porta 4000)
log_info "Iniciando Frontend Next.js em http://localhost:4000"
cd frontend
PORT=4000 npm run dev > ../logs/frontend.log 2>&1 &
FRONTEND_PID=$!
cd ..

# Aguardar frontend estar pronto
sleep 3

# Status final
echo ""
log_success "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
log_success "  Ambiente de desenvolvimento pronto!"
log_success "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo ""
echo -e "${GREEN}üìç Servi√ßos dispon√≠veis:${NC}"
echo -e "   üî∑ Frontend:    ${BLUE}http://localhost:4000${NC}"
echo -e "   üî∂ Backend:     ${BLUE}http://localhost:3001${NC}"
echo -e "   üêò PostgreSQL:  ${BLUE}localhost:5433${NC}"
echo -e "   üî¥ Redis:       ${BLUE}localhost:6380${NC}"
echo ""
echo -e "${YELLOW}üìã Credenciais padr√£o:${NC}"
echo -e "   Email:    admin@fono.com"
echo -e "   Senha:    admin123456"
echo ""
echo -e "${YELLOW}üìä Logs:${NC}"
echo -e "   Backend:  tail -f logs/backend.log"
echo -e "   Frontend: tail -f logs/frontend.log"
echo ""
echo -e "${YELLOW}‚öôÔ∏è  Comandos √∫teis:${NC}"
echo -e "   Console Rails:     cd backend && bundle exec rails console"
echo -e "   Migrations:        cd backend && bundle exec rails db:migrate"
echo -e "   Reset DB:          cd backend && bundle exec rails db:reset"
echo -e "   Parar containers:  docker-compose down"
echo ""
log_warn "Pressione Ctrl+C para encerrar todos os servi√ßos"
echo ""

# Manter script rodando e mostrar logs combinados
tail -f logs/backend.log -f logs/frontend.log 2>/dev/null || wait
